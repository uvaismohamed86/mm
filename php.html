<?php
/*
=========================================
 SQL to Create Database & Tables
-----------------------------------------
CREATE DATABASE fmb_system;
USE fmb_system;

CREATE TABLE users (
    id INT AUTO_INCREMENT PRIMARY KEY,
    username VARCHAR(50) UNIQUE,
    password VARCHAR(255),
    role ENUM('admin','agent')
);

INSERT INTO users (username, password, role) VALUES
('adminadmin', MD5('adminadmin'), 'admin'),
('agent1', MD5('agent1'), 'agent');

CREATE TABLE service_requests (
    id INT AUTO_INCREMENT PRIMARY KEY,
    name VARCHAR(100),
    email VARCHAR(100),
    phone VARCHAR(20),
    crop_type VARCHAR(50),
    fmb_details TEXT,
    boundary_coords TEXT,
    gps_location TEXT,
    photo_path VARCHAR(255),
    payment_status VARCHAR(20),
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

CREATE TABLE job_applications (
    id INT AUTO_INCREMENT PRIMARY KEY,
    name VARCHAR(100),
    email VARCHAR(100),
    phone VARCHAR(20),
    job_intro TEXT,
    job_desc TEXT,
    resume_path VARCHAR(255),
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);
=========================================
*/

// --- CONFIG ---
session_start();
$db = new mysqli("localhost", "root", "", "fmb_system");
if ($db->connect_error) { die("DB Connection Failed: " . $db->connect_error); }

// --- LOGIN HANDLER ---
if (isset($_POST['login'])) {
    $u = $_POST['username'];
    $p = md5($_POST['password']);
    $res = $db->query("SELECT * FROM users WHERE username='$u' AND password='$p'");
    if ($res->num_rows > 0) {
        $user = $res->fetch_assoc();
        $_SESSION['user'] = $user['username'];
        $_SESSION['role'] = $user['role'];
    } else {
        $login_error = "Invalid username or password.";
    }
}

// --- LOGOUT ---
if (isset($_GET['logout'])) {
    session_destroy();
    header("Location: index.php");
    exit;
}

// --- SERVICE REQUEST HANDLER ---
if (isset($_POST['service_submit'])) {
    $name = $_POST['name'];
    $email = $_POST['email'];
    $phone = $_POST['phone'];
    $crop = $_POST['crop_type'];
    $fmb = $_POST['fmb_details'];
    $boundary = $_POST['boundary_coords'];
    $gps = $_POST['gps_location'];

    // Photo upload
    $photo_path = "";
    if (!empty($_FILES['photo']['name'])) {
        $photo_path = "uploads/" . basename($_FILES['photo']['name']);
        move_uploaded_file($_FILES['photo']['tmp_name'], $photo_path);
    }

    $db->query("INSERT INTO service_requests (name,email,phone,crop_type,fmb_details,boundary_coords,gps_location,photo_path,payment_status)
    VALUES ('$name','$email','$phone','$crop','$fmb','$boundary','$gps','$photo_path','pending')");
    $service_msg = "Service request submitted successfully!";
}

// --- JOB APPLICATION HANDLER ---
if (isset($_POST['job_submit'])) {
    $name = $_POST['name'];
    $email = $_POST['email'];
    $phone = $_POST['phone'];
    $intro = $_POST['job_intro'];
    $desc = $_POST['job_desc'];

    $resume_path = "";
    if (!empty($_FILES['resume']['name'])) {
        $resume_path = "uploads/" . basename($_FILES['resume']['name']);
        move_uploaded_file($_FILES['resume']['tmp_name'], $resume_path);
    }

    $db->query("INSERT INTO job_applications (name,email,phone,job_intro,job_desc,resume_path)
    VALUES ('$name','$email','$phone','$intro','$desc','$resume_path')");
    $job_msg = "Job application submitted successfully!";
}

// --- CSV EXPORT ---
if (isset($_GET['export']) && $_SESSION['role'] == 'admin') {
    header('Content-Type: text/csv');
    header('Content-Disposition: attachment;filename=data.csv');
    $out = fopen('php://output', 'w');
    fputcsv($out, ['ID','Name','Email','Phone','Crop','FMB','Boundary','GPS','Photo','Payment','Date']);
    $res = $db->query("SELECT * FROM service_requests");
    while ($row = $res->fetch_assoc()) {
        fputcsv($out, $row);
    }
    fclose($out);
    exit;
}
?>
<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>FMB Services System</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<!-- Bootstrap CSS -->
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
<style>
body { padding-top: 56px; }
.banner { background-size: cover; background-position: center; height: 300px; color: white; display: flex; align-items: center; justify-content: center; text-shadow: 2px 2px 5px black; }
</style>
</head>
<body>

<!-- NAVBAR -->
<nav class="navbar navbar-expand-lg navbar-dark bg-dark fixed-top">
  <div class="container-fluid">
    <a class="navbar-brand" href="#">FMB Services</a>
    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#nav">
      <span class="navbar-toggler-icon"></span>
    </button>
    <div class="collapse navbar-collapse" id="nav">
      <ul class="navbar-nav ms-auto">
        <li class="nav-item"><a class="nav-link" href="#services">Services</a></li>
        <li class="nav-item"><a class="nav-link" href="#jobs">Jobs</a></li>
        <li class="nav-item"><a class="nav-link" href="#login">Login</a></li>
      </ul>
    </div>
  </div>
</nav>

<!-- BANNER -->
<div class="banner" style="background-image:url('data:image/jpeg;base64,PUT-YOUR-BASE64-DRONE-IMAGE-HERE');">
  <h1>Welcome to FMB Drone Services</h1>
</div>

<div class="container mt-4">

<!-- SERVICES SECTION -->
<section id="services">
<h2>Our Services</h2>
<div class="row">
<div class="col-md-4"><div class="card"><div class="card-body"><h5>FMB Mapping</h5><p>Field mapping with drones</p></div></div></div>
<div class="col-md-4"><div class="card"><div class="card-body"><h5>Pesticide Spraying</h5><p>Precision spraying</p></div></div></div>
<div class="col-md-4"><div class="card"><div class="card-body"><h5>Crops: Tea, Coffee, Others</h5><p>Crop monitoring</p></div></div></div>
</div>

<h3 class="mt-4">Request a Service</h3>
<?php if(isset($service_msg)) echo "<div class='alert alert-success'>$service_msg</div>"; ?>
<form method="post" enctype="multipart/form-data">
<input type="hidden" name="service_submit" value="1">
<div class="mb-2"><input name="name" class="form-control" placeholder="Name" required></div>
<div class="mb-2"><input name="email" class="form-control" placeholder="Email" required></div>
<div class="mb-2"><input name="phone" class="form-control" placeholder="Phone" required></div>
<div class="mb-2">
<select name="crop_type" class="form-control">
<option>Tea</option>
<option>Coffee</option>
<option>Rice</option>
<option>Wheat</option>
<option>Other</option>
</select>
</div>
<div class="mb-2"><textarea name="fmb_details" class="form-control" placeholder="FMB Details" required></textarea></div>
<div class="mb-2"><textarea name="boundary_coords" class="form-control" placeholder="Boundary Coordinates" required></textarea></div>
<div class="mb-2"><input name="gps_location" class="form-control" placeholder="GPS Location"></div>
<div class="mb-2"><input type="file" name="photo" class="form-control"></div>
<button class="btn btn-primary">Submit Request</button>
</form>
</section>

<!-- JOBS SECTION -->
<section id="jobs" class="mt-5">
<h2>Apply for a Job</h2>
<?php if(isset($job_msg)) echo "<div class='alert alert-success'>$job_msg</div>"; ?>
<form method="post" enctype="multipart/form-data">
<input type="hidden" name="job_submit" value="1">
<div class="mb-2"><input name="name" class="form-control" placeholder="Name" required></div>
<div class="mb-2"><input name="email" class="form-control" placeholder="Email" required></div>
<div class="mb-2"><input name="phone" class="form-control" placeholder="Phone" required></div>
<div class="mb-2"><textarea name="job_intro" class="form-control" placeholder="Job Introduction"></textarea></div>
<div class="mb-2"><textarea name="job_desc" class="form-control" placeholder="Job Description"></textarea></div>
<div class="mb-2"><input type="file" name="resume" class="form-control"></div>
<button class="btn btn-success">Submit Application</button>
</form>
</section>

<!-- LOGIN SECTION -->
<section id="login" class="mt-5">
<h2>Login</h2>
<?php if(isset($login_error)) echo "<div class='alert alert-danger'>$login_error</div>"; ?>
<form method="post">
<div class="mb-2"><input name="username" class="form-control" placeholder="Username" required></div>
<div class="mb-2"><input type="password" name="password" class="form-control" placeholder="Password" required></div>
<button name="login" class="btn btn-dark">Login</button>
</form>
</section>

<!-- ADMIN / AGENT DASHBOARD -->
<?php if(isset($_SESSION['user'])): ?>
<hr><h2>Welcome, <?= $_SESSION['user'] ?> (<?= $_SESSION['role'] ?>)</h2>
<a href="?logout=1" class="btn btn-danger mb-3">Logout</a>
<?php if($_SESSION['role']=='admin'): ?>
<a href="?export=1" class="btn btn-info mb-3">Export CSV</a>
<h3>Service Requests</h3>
<table class="table table-bordered"><tr><th>ID</th><th>Name</th><th>Crop</th><th>GPS</th><th>Date</th></tr>
<?php $res=$db->query("SELECT * FROM service_requests"); while($row=$res->fetch_assoc()): ?>
<tr><td><?= $row['id'] ?></td><td><?= $row['name'] ?></td><td><?= $row['crop_type'] ?></td><td><?= $row['gps_location'] ?></td><td><?= $row['created_at'] ?></td></tr>
<?php endwhile; ?>
</table>
<?php else: ?>
<h3>Your Assigned Requests</h3>
<p>(Agent view - filtered data could go here)</p>
<?php endif; ?>
<?php endif; ?>

</div>

<!-- Bootstrap JS -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
